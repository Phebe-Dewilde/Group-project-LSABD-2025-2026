---
title: "Univariate Analysis – APC2 Methylation in Colon Samples"
output: html_notebook

# RQ: Does promoter methylation of APC2_1 differ between stage 0 (healthy) and stage IV colon cancers?
# Hypotheses:
#- H0: Promoter methylation of APC2_1 does not differ between stage 0 (healthy) and stage IV colon cancers.
#- H1: Promoter methylation of APC2_1 differs between stage 0 (healthy) and stage IV colon cancers.


---
0. Load packages ----
```{r}
library(tidyverse)
library(stringr)
```

1. Load imputed data ----

The aim of this univariate analysis is to investigate whether methylation levels of the APC2 gene differ between healthy colon samples (clinical stage 0) and advanced colon cancer samples (clinical stage IV).
We focus on a biologically relevant gene and assess distributional properties, outliers, and the suitability of non-parametric testing.
```{r}
df_imputed <- read.csv("C:/Users/phebe/OneDrive - UGent/Large Scale Data analysis/files/df_imputed.csv", check.names = FALSE)
```

2. Univariate specific metadata cleaning ----

2.1 Cleaning up column names by adding underscores -> was overlooked during the general preprocessing
```{r}
colnames(df_imputed)[colnames(df_imputed) == "label_clinical stage"] <- "label_clinical_stage"
colnames(df_imputed)[colnames(df_imputed) == "label_site label"] <- "label_site_label"
```

2.2 Removal of NAs in label_clinical_stage column - Keep samples with a valid clinical stage.
Since the feature label_clinical_stage is considered for the univariate analysis, rows that have unknown values or NAs for label_clinical_stage are removed.

```{r}
uni_df <- df_imputed[
  !is.na(df_imputed$label_clinical_stage) &                # geen NA
  trimws(df_imputed$label_clinical_stage) != "" &          # geen lege cellen
  tolower(df_imputed$label_clinical_stage) != "unknown",   # geen unknown
]
#check distribution of different stages 
table(uni_df$label_clinical_stage)
```

3. Restrict to colon samples (healthy colon + colon cancer) ----

Since APC2 is biologically relevant in colorectal cancer, we restrict our dataset to colon and colon-tumor tissue samples.
Only samples with label_tissue == "Colon" or "Colon_and_rectum_cancer" are kept.
```{r}
df_filtered_colon <- uni_df %>%
  filter(label_tissue %in% c("Colon_and_rectum_cancer",
                             "Colon"))
```

4. Choose a gene for univariate analysis ----

Restrict to APC-related CpGs= biologial relevance (as described in the report)

```{r}
apc_cols <- grep("^APC_", names(df_filtered_colon), value = TRUE)
grep("APC", names(df_filtered_colon), value = TRUE)
```

Among all APC-related loci, we select the APC2 CpG sites.
Because different CpG sites within a gene may vary in informativeness, we compute the variance of each APC2 locus.
The CpG with the highest variance (APC2_1) is used for further analysis, as it captures the strongest biological variability between samples.
```{r}
apc2_cols <- grep("^APC2_", names(df_filtered_colon), value = TRUE)
apc2_cols
apc2_data <- df_filtered_colon[, apc2_cols]
apc2_variances <- apply(apc2_data, 2, var)
APC2_top_gene <- names(which.max(apc2_variances))

APC2_top_gene

```

5. Build univariate analysis dataset: stage 0 vs stage IV ----

We construct two groups based on clinical stage:

Stage 0 — healthy control samples

Stage IV — advanced tumor samples

We focus on these two extremes to maximize detectable contrast.
Stage IV is encoded as the Unicode Roman numeral "Ⅳ", which is matched explicitly during filtering.
```{r}
uni_df_stat <- df_filtered_colon %>%
  filter(label_clinical_stage %in% c("0", "Ⅳ")) %>%    # stage 0 and stage IV
  mutate(
    group = factor(
      label_clinical_stage,
      levels = c("0", "Ⅳ"),
      labels = c("Stage_0", "Stage_IV")
    )
  )
```

6. QQ-plot diagnostics ---- 

The QQ-plot is included solely as a diagnostic tool.
Methylation beta-values are bounded between 0 and 1 and therefore cannot follow a true normal distribution, even if the plot appears approximately linear.
This visualization confirms that a parametric t-test is not appropriate.
(Deviations in the tails confirm non-normality → Wilcoxon is appropriate.)
```{r}
qqnorm(uni_df_stat[[APC2_top_gene]])
qqline(uni_df_stat[[APC2_top_gene]], col = "red", lwd = 2)
```

7. Descriptive statistics by group ----
```{r}
uni_summary <- uni_df_stat %>%
  group_by(group) %>%
  summarise(
    n      = n(),
    mean   = mean(.data[[APC2_top_gene]], na.rm = TRUE),
    sd     = sd(.data[[APC2_top_gene]], na.rm = TRUE),
    median = median(.data[[APC2_top_gene]], na.rm = TRUE),
    IQR    = IQR(.data[[APC2_top_gene]], na.rm = TRUE)
  )

uni_summary
```

8. Outlier inspection (visual only) ----

A visual inspection reveals a few outliers, which is typical for methylation data and reflects natural biological variability.
Because the Mann–Whitney U test (Wilcoxon rank-sum test) is robust to outliers and rank-based, no samples were removed.
```{r}
ggplot(uni_df_stat, aes(y = .data[[APC2_top_gene]], x = "")) +
  geom_boxplot(outlier.colour = "red", alpha = 0.6) +
  labs(title = paste("Outlier visualization for", APC2_top_gene),
       y = "Methylation (beta-value)",
       x = "")
```

9.Statistical testing: Wilcoxon rank-sum test (robust to non-normality) ----

Given the non-normal distribution of beta-values and the independence of the groups, we apply the Mann–Whitney U test (wilcox.test() in R).
This test compares group medians without requiring normality.
```{r}
wilcox_res <- wilcox.test(
  uni_df_stat[[APC2_top_gene]] ~ uni_df_stat$group,
  exact = FALSE
)

wilcox_res
```

10. Visualisations ----

The violin plot illustrates the full density distribution for each group.
Both distributions exhibit similar shapes and substantial overlap, consistent with the absence of a significant difference.

10.1 Boxplot with jittered points 
```{r}
ggplot(uni_df_stat, aes(
  x = group,
  y = .data[[APC2_top_gene]],
  fill = group
)) +
  geom_boxplot(width = 0.15, outlier.shape = NA, alpha = 0.7) +
  geom_jitter(width = 0.08, alpha = 0.6, size = 2, color = "black") +
  scale_fill_manual(values = c("#6AAED6", "#CC4C4C")) +
  labs(
    title = paste("Methylation of", APC2_top_gene, "in stage 0 VS stage IV"),
    x = "Clinical stage",
    y = "Methylation (beta-value)"
  ) +
  theme_bw(base_size = 13) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", hjust = 0.5)
  )
```






